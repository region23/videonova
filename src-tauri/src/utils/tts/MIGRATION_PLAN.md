# План миграции TTS системы

## Текущее состояние

**Обновление**: Рефакторинг полностью завершен. Модульная архитектура TTS системы реализована и устаревший модуль `tts.rs` удален. Все клиентские вызовы переведены на новый API.

## График миграции

### Фаза 1: Подготовка (завершена)

- [x] Разделение монолитного `tts.rs` на логические модули
- [x] Реализация нового API в новых модулях
- [x] Создание обратно-совместимого слоя
- [x] Миграция основного клиентского кода
- [x] Пометка устаревших функций с помощью `#[deprecated]`
- [x] Добавление документации и тестов

### Фаза 2: Сборка с предупреждениями (завершена)

- [x] Убедиться, что при компиляции отображаются предупреждения о использовании устаревших функций
- [x] Выпустить промежуточную версию с полностью функциональным новым API и пометками об устаревании
- [x] Мониторинг логов для выявления мест использования устаревшего API

### Фаза 3: Подготовка к полному удалению (завершена)

- [x] Убедиться, что весь клиентский код переведен на новый API
- [x] Провести дополнительное тестирование нового API
- [x] Обновить документацию для новых версий
- [x] Включить в тесты проверку отсутствия использования устаревшего API

### Фаза 4: Полное удаление обратной совместимости (завершена)

- [x] Удалить обратно-совместимый слой `tts.rs`
- [x] Удалить все ссылки на устаревшие типы и функции
- [x] Выпустить мажорную версию с полностью обновленным API

## Рекомендации по миграции

Для разработчиков, использующих старый API, рекомендуется следующий порядок миграции:

### 1. Обновление импортов

**Старый код (больше не поддерживается):**
```rust
use crate::utils::tts::tts::{SyncConfig, TtsConfig, process_sync};
```

**Новый код:**
```rust
use crate::utils::tts::{
    synchronize_tts, SyncConfig, TtsVoiceConfig, AudioProcessingConfig
};
```

### 2. Замена создания конфигурации

**Старый код (больше не поддерживается):**
```rust
let config = SyncConfig::new(api_key, vtt_path, output_wav);
config.tts_config.voice = "alloy".to_string();
```

**Новый код:**
```rust
let config = SyncConfig {
    vtt_path: vtt_path.to_str().unwrap_or(""),
    output_wav: output_wav.to_path_buf(),
    api_key,
    tts_config: TtsVoiceConfig {
        voice: "alloy".to_string(),
        ..TtsVoiceConfig::default()
    },
    audio_config: AudioProcessingConfig::default(),
    original_audio_path: None,
    progress_sender: None,
};
```

### 3. Замена вызова функции

**Старый код (больше не поддерживается):**
```rust
process_sync(config).await?;
```

**Новый код:**
```rust
let output_path = synchronize_tts(config).await?;
```

### 4. Замена функции удаления вокала

**Старый код (больше не поддерживается):**
```rust
use crate::utils::tts::tts::demucs::remove_vocals;

remove_vocals(input_path, output_path, progress_sender, None).await?;
```

**Новый код:**
```rust
use crate::utils::tts::separate_audio;

let (instrumental_path, _) = separate_audio(
    input_path.to_path_buf(), 
    output_dir.to_path_buf(), 
    progress_sender
).await?;
```

## Преимущества завершённой миграции

1. **Улучшенная модульность**: Каждый компонент отвечает за свою функциональность
2. **Лучшая тестируемость**: Модульная структура упрощает написание тестов
3. **Улучшенная читаемость кода**: Ясное разделение ответственности
4. **Более гибкая конфигурация**: Улучшенная настройка параметров
5. **Простота расширения**: Добавление новых функций не требует изменения всей системы
6. **Уменьшенная сложность**: Удаление дублирующего обратно-совместимого кода

## Выводы

Миграция TTS системы с монолитной на модульную архитектуру успешно завершена. Структура кода стала более прозрачной, удобной для тестирования и расширения. Все компоненты теперь имеют четко определенные обязанности, что облегчает поддержку и развитие системы в будущем.

Устаревший API был полностью удален, что предотвращает возникновение путаницы и гарантирует, что все новые изменения будут использовать современный модульный дизайн. 