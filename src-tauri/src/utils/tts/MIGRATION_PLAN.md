# План миграции TTS системы

## Текущее состояние

В результате рефакторинга TTS системы был создан новый модульный API, который заменяет монолитный дизайн. В настоящее время:

1. Модульная архитектура полностью реализована
2. Старое API отмечено как устаревшее (`#[deprecated]`)
3. Клиентский код в `commands.rs` уже мигрирован на новый API
4. Добавлена подробная документация и тесты

Однако для полного завершения рефакторинга необходимо постепенно удалить обратно-совместимый слой.

## График миграции

### Фаза 1: Подготовка (завершена)

- [x] Разделение монолитного `tts.rs` на логические модули
- [x] Реализация нового API в новых модулях
- [x] Создание обратно-совместимого слоя
- [x] Миграция основного клиентского кода
- [x] Пометка устаревших функций с помощью `#[deprecated]`
- [x] Добавление документации и тестов

### Фаза 2: Сборка с предупреждениями (Текущая, 1-2 месяца)

- [x] Убедиться, что при компиляции отображаются предупреждения о использовании устаревших функций
- [ ] Выпустить промежуточную версию с полностью функциональным новым API и пометками об устаревании
- [ ] Мониторинг логов для выявления мест использования устаревшего API

### Фаза 3: Подготовка к полному удалению (3-4 месяца)

- [ ] Убедиться, что весь клиентский код переведен на новый API
- [ ] Провести дополнительное тестирование нового API
- [ ] Обновить документацию для новых версий
- [ ] Включить в тесты проверку отсутствия использования устаревшего API

### Фаза 4: Полное удаление обратной совместимости (5-6 месяцев)

- [ ] Удалить обратно-совместимый слой `tts.rs`
- [ ] Удалить все ссылки на устаревшие типы и функции
- [ ] Выпустить мажорную версию с полностью обновленным API

## Рекомендации по миграции

Для разработчиков, использующих старый API, рекомендуется следующий порядок миграции:

### 1. Обновление импортов

**Старый код:**
```rust
use crate::utils::tts::tts::{SyncConfig, TtsConfig, process_sync};
```

**Новый код:**
```rust
use crate::utils::tts::{
    synchronize_tts, SyncConfig, TtsVoiceConfig, AudioProcessingConfig
};
```

### 2. Замена создания конфигурации

**Старый код:**
```rust
let config = SyncConfig::new(api_key, vtt_path, output_wav);
config.tts_config.voice = "alloy".to_string();
```

**Новый код:**
```rust
let config = SyncConfig {
    vtt_path: vtt_path.to_str().unwrap_or(""),
    output_wav: output_wav.to_path_buf(),
    api_key,
    tts_config: TtsVoiceConfig {
        voice: "alloy".to_string(),
        ..TtsVoiceConfig::default()
    },
    audio_config: AudioProcessingConfig::default(),
    original_audio_path: None,
    progress_sender: None,
};
```

### 3. Замена вызова функции

**Старый код:**
```rust
process_sync(config).await?;
```

**Новый код:**
```rust
let output_path = synchronize_tts(config).await?;
```

### 4. Замена функции удаления вокала

**Старый код:**
```rust
use crate::utils::tts::tts::demucs::remove_vocals;

remove_vocals(input_path, output_path, progress_sender, None).await?;
```

**Новый код:**
```rust
use crate::utils::tts::separate_audio;

let (instrumental_path, _) = separate_audio(
    input_path.to_path_buf(), 
    output_dir.to_path_buf(), 
    progress_sender
).await?;
```

## Проблемы совместимости

При миграции следует обратить внимание на следующие потенциальные проблемы:

1. **Изменение типов возвращаемых значений**:
   - `process_sync` возвращает `Result<()>`
   - `synchronize_tts` возвращает `Result<PathBuf>`

2. **Изменение структуры конфигурации**:
   - Старый `SyncConfig` принимал пути как `&Path`
   - Новый `SyncConfig` принимает пути как `&str` и `PathBuf`

3. **Изменение обработки ошибок**:
   - API ошибок тот же самый, но места возникновения ошибок могут отличаться

## Преимущества миграции

1. **Улучшенная модульность**: Каждый компонент отвечает за свою функциональность
2. **Лучшая тестируемость**: Модульная структура упрощает написание тестов
3. **Улучшенная читаемость кода**: Ясное разделение ответственности
4. **Более гибкая конфигурация**: Улучшенная настройка параметров
5. **Простота расширения**: Добавление новых функций не требует изменения всей системы

## Мониторинг использования устаревшего API

Для отслеживания использования устаревшего API, мы будем использовать:

1. **Предупреждения компилятора**: Аннотации `#[deprecated]` вызывают предупреждения
2. **Логирование**: Добавленные логи при использовании устаревших функций
3. **Сбор телеметрии**: Анонимное отслеживание использования API (опционально)

## Коммуникация с пользователями API

1. **Обновление документации**: Подробные инструкции по миграции
2. **Примеры кода**: Примеры использования нового API
3. **Объявления о изменениях**: Включение информации о планируемом удалении старого API в релизы

## Выводы

Миграция TTS системы с монолитной на модульную архитектуру значительно улучшит качество кода, тестируемость и расширяемость. Предложенный план обеспечивает плавный переход на новый API с минимальными нарушениями для существующего кода. 